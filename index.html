const SPREADSHEET_ID = "1BgblyT5GHjmXmVDby9RfnNahLZdLQXO6TsFHj1IueMQ";
const SHEET_NAME = "나 한준희요";
const GEMINI_API_KEY = "AIzaSyDiaMQy1afOZKwCtuSSkxPqfRf_RnGEF64"; // 실제 API 키로 대체 필요

function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('여행 계획 추천기');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename)
    .getContent();
}

/**
 * 사용자 입력 데이터를 받아 Gemini API로 여행 계획을 생성하고 Google Sheet에 저장합니다.
 * @param {Object} formData - 사용자 입력 데이터 (여행 목적지, 인원, 기간 등)
 * @returns {Object} - 생성된 여행 계획 또는 에러 메시지
 */
function generateTravelPlan(formData) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  if (!sheet) {
    return {
      success: false,
      message: "시트 이름을 찾을 수 없습니다: " + SHEET_NAME
    };
  }

  try {
    const {
      destination,
      adults,
      children,
      duration,
      travelStyle,
      budget
    } = formData;

    // Gemini API 호출을 위한 프롬프트 구성
    const prompt = `
      "${destination}"(으)로 ${adults}명 성인, ${children}명 아이가 ${duration}일 동안 ${travelStyle} 컨셉으로 여행을 가려고 합니다.
      예산은 ${budget}입니다. 이 조건에 맞춰 상세한 여행 계획을 추천해 주세요.
      계획은 여행의 전체적인 콘셉트, 일자별 상세 일정(방문 장소, 활동, 예상 시간), 추천 맛집, 이동 수단, 숙소 제안 등
      구체적이고 실용적인 내용으로 구성해 주세요. 답변은 가독성이 좋게 마크다운 형식으로 작성해 주세요.
    `;

    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
    const options = {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }]
      })
    };

    const response = UrlFetchApp.fetch(geminiUrl, options);
    const data = JSON.parse(response.getContentText());

    let generatedPlan = "여행 계획을 생성하는 데 실패했습니다. 다시 시도해 주세요.";
    if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
      generatedPlan = data.candidates[0].content.parts[0].text;
    } else {
      console.error("Gemini API 응답 형식 오류:", data);
      return {
        success: false,
        message: "Gemini API 응답을 처리할 수 없습니다."
      };
    }

    // Google Sheet에 데이터 저장
    const timestamp = new Date();
    sheet.appendRow([timestamp, destination, adults, children, budget, travelStyle, duration, generatedPlan]);

    return {
      success: true,
      plan: generatedPlan
    };

  } catch (e) {
    console.error("여행 계획 생성 중 오류 발생: ", e.toString());
    return {
      success: false,
      message: "여행 계획 생성 중 오류가 발생했습니다: " + e.message
    };
  }
}
